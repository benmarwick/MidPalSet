---
title: "Assessing the spatial patterning of Middle Paleolithic human settlement in Western Iberia"
author:
  - João Cascalheira
  - Célia Gonçalves
  - Daniela Maio
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  Middle Paleolithic; Settlement patterns; GIS; Western Iberia
---


<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r, setup, eval = FALSE, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/"
)

#library(MidPalSet) # Or use devtools::load_all('.', quiet = T) if your code is in script files, rather than as functions in the `/R` directory

library(rgdal)
library(raster)
library(rasterVis)
library(lattice)
library(foreach)
library(rnaturalearth)
library(tidyverse)
library(ggplot2)
library(broom)
library(foreach)
library(sf)
library(osfr)
library(cowplot)
library(gridExtra)
library(rela)
library(psych)
library(factoextra)

```


```{r load-spatial-data, eval = FALSE, echo = FALSE}

#Download geo tiffs from OSF repositorium when running this document for the first time

#osf_retrieve_file("nv6r8") %>%
#  osf_download(path = "../data/raw_data")
#osf_retrieve_file("jb6v8") %>%
#  osf_download(path = "../data/raw_data")
#osf_retrieve_file("yxk23") %>%
#  osf_download(path = "../data/raw_data")
#osf_retrieve_file("57qfn") %>%
#  osf_download(path = "../data/raw_data")
#osf_retrieve_file("mx2bt") %>%
#  osf_download(path = "../data/raw_data")

#Import geo tiffs
areaDEM <- raster("../data/raw_data/areaDEM.tif")
areaDEM_cut <- raster("../data/raw_data/areaDEM_cut.tif")
areaSLOPE_cut <- raster("../data/raw_data/areaSLOPE_cut.tif")
areaASPECT_cut <- raster("../data/raw_data/areaASPECT_cut.tif")
areaDIST_cut <- raster("../data/raw_data/areaDIST_cut2.tif")


# Convert coordinates to longlat WGS84
areaDEM <- projectRaster(areaDEM, crs="+proj=longlat +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")
areaDEM_cut <- projectRaster(areaDEM_cut, crs="+proj=longlat +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")
areaSLOPE_cut <- projectRaster(areaSLOPE_cut, crs="+proj=longlat +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")
areaASPECT_cut <- projectRaster(areaASPECT_cut, crs="+proj=longlat +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")
areaDIST_cut <- projectRaster(areaDIST_cut, crs="+proj=longlat +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")


#Import sites and convert to shapefile
#sites <- read.csv("../data/raw_data/sites_short_list.csv", header=TRUE)
#caves <- read.csv("../data/raw_data/all_caves.csv", header=TRUE)

#Convert to shapefile
#coordinates(sites)<-~Longitude+Latitude
#proj4string(sites) = CRS("+init=epsg:4326")
#writeOGR(sites, "../data/raw_data/spatial_data/shapefiles","sites_short", "ESRI Shapefile")

#coordinates(caves)<-~Longitude+Latitude
#proj4string(caves) = CRS("+init=epsg:4326")
#writeOGR(caves, "../data/raw_data/spatial_data/shapefiles","caves", "ESRI Shapefile")


#Read shapefiles
sites_short <- readOGR(dsn="../data/raw_data/spatial_data/shapefiles", layer="sites_short")
caves <- readOGR(dsn="../data/raw_data/spatial_data/shapefiles", layer="caves")
#rivers <- readOGR(dsn="../data/raw_data/spatial_data/shapefiles", layer="RHidro_Rivers_v2")

#Filter sites by Type
sites_sub <- sites_short[sites_short$Type == "Cave" | sites_short$Type == "Open air",]
sites_sub$Type <- factor(sites_sub$Type)

#Convert coordinates to longlat WGS84
sites_sub_long <- spTransform(sites_sub, "+proj=longlat +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")

caves_long <- spTransform(caves, "+proj=longlat +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")

```



```{r extract-spatial-variables, eval = FALSE, echo = FALSE}

# Extract variables

# Resample Distance raster
areaDIST_cut <- resample(areaDIST_cut,areaDEM_cut, resample='bilinear')

# Stack maps
terrainstack <- stack(areaDEM_cut,
                      areaSLOPE_cut,
                      areaASPECT_cut,
                      areaDIST_cut)

# Extract mean values from stack for each site and all caves within a 20 m radius
sites_vals <- raster::extract(terrainstack,
                      sites_sub_long,
                      buffer = 20,
                      fun = mean,
                      sp = TRUE)

caves_vals <- raster::extract(terrainstack,
                              caves_long,
                              buffer = 20,
                              fun = mean,
                              sp = TRUE)


# Subdivide sites for further analysis
open_air <- dplyr::filter(as.data.frame(sites_vals), Type == "Open air")
caves <- dplyr::filter(as.data.frame(sites_vals), Type == "Cave")
all_caves <- as.data.frame(caves_vals)

```


# Introduction





```{r general-map, eval = FALSE, echo = FALSE}

rasterVis::levelplot(areaDEM,
                     margin = list(x = FALSE,
                                   y = TRUE),
                     col.regions = terrain.colors(16),
                     xlab = list(label = "",
                                 vjust = -0.25),
                     sub = list(
                       label = "Meters a.s.l.",
                       font = 1,
                       cex = .9,
                       hjust = 0.5),
                     colorkey=list(space="bottom"),
                     key = list(
                       space = "left",
                       points = list(
                         pch = c(18,20),
                         col = c("red","blue")),
                       text = list(
                         c("Cave","Open-air"),
                         cex=1))) +
  spplot(sites_sub_long, # add a layer of points
         zcol = "Type",
         cex = 2,
         pch = c(18,20),
         col.regions = c("red","blue"))

```


```{r chrono-table, eval = FALSE, echo = FALSE}

chrono <- read_csv("../data/raw_data/chronology.csv")

knitr::kable(chrono, caption = "Absolutes dates for the Middle Paleolithic in westernmost Europe.")


```


# Methods

## Site selection

A dataset comprising all Middle Paleolithic sites reported in Portugal was created using the Endovélico – Archaeological Management and Information System, curated by the Direção Geral do Património Cultural (DGPC) (http://arqueologia.patrimoniocultural.pt/). This initial dataset included all entries with associated geographic information, in a total of 274 locations. Most of these sites, however, are dubiously attributed to the Middle Paleolithic, since in most cases there is no associated dating, nor reporting of any clear evidence of distinctive Middle Paleolithic stone tools within the assemblages. These inconsistencies are a result of the fact that many of the reported locations are surface findings, attributed to the Middle Paleolithic based on the rudimentary aspect of the lithic materials. 

To avoid, as much as possible, the inclusion of erroneous information in the database we adopted the filtering scheme presented in Figure XXX. Thus, using the initial list we cross-check information with data from publications and reports, subdividing the sample into two other sub-samples: the first, represented by 54 sites, integrating all contexts for which we were able to confirm their chronological attribution to the Middle Paleolithic, either by absolute or relative chronology; the second, comprising 46 sites, composed of all the contexts for which we were able to collect lithic raw materials information. Sites were characterized as open-air or cave/rockshelter sites, and the dominant raw material in each site, measured as the material representing more than 60% of all lithic artifacts in the assemblage, was recorded.


## GIS and statistical analysis

The location of sites included in the short samples were checked and validated by visual inspection using satellite imagery in Google Earth. A series of raster layers with digital geographical information were exported from ArcGIS (v.10.6), including: a 30X30-m pixel Digital Elevation Model (DEM), obtained from the Shuttle Radar Topography Mission (Farr et al., 2007); Slope and Aspect maps were obtained from the DEM raster (see Burrough et al., 2015 for the definition and calculation details), and a euclidean distance raster using a 1:25.000-scale water courses vector layer as input source, including all hydrological classes in the dataset.

All raster layers and sites' database were imported into the R Statistical Environment. Spatial variables (Elevation, Slope, Aspect and Distance to rivers) were extracted from these rasters using a series of functions within the Raster package. Following previous works by XXX, values were extracted calculating a 20 meters radius buffer around each site location and then averaging the values of each spatial variable within those buffers.

To analyze individual variables two approaches were undertaken separating open-air sites and caves. This separation is based on the fact that while open-air sites can presumably be located in any point across the landscape, the same is not true for cave sites, since their location is limited in terms of lithological background.

Thus, for open-air sites, following standard approaches in spatial pattern analysis, comparisons were made between site variable distributions and random samples variable distributions. Here, we adopted the approach used by Bocinsky (XXX) based on the calculation of the probability density estimate for sites, the estimation of a probability density curve for all cells composing the landscape using Monte Carlo resampling, and finally comparing the two distributions using a Mann-Whitney U test. For random locations, the probability densities for 1000 random samples were extracted from each raster layer. Each sample was of the same number of locations as there are open-air archaeological sites (i.e. n = 36). Based on this, a 95% confidence interval for the sampled data using quantiles was calculated and plotted together with the kernel density curves. The same resampling method was used to generate confidence intervals for the Mann-Whitney U test statistic.

Random points extraction was limited to the territories south of the Douro river valley because our database did not include any archaeological sites situated to the north of that river.

For the caves sample, site locations were instead compared with a dataset comprising all caves with attested human occupations present in the Endovélico database (n = 114). Given the small sample size, statistical comparisons were accomplished without resampling, based on independent 2-group Mann-Whitney U Test.

A Principal Component Analysis (PCA) was also used to explore any latent patterns of association among the different spatial and archaeological variables. This step combined open-air and cave locations, using all four spatial variables (Elevation, Slope, Aspect and Distance to rivers) as active variables and the dominant raw material as grouping variable.



```{r pca-eval, eval = FALSE, echo = FALSE}

pca_data <- as.data.frame(sites_vals)

pca_data <- pca_data %>% 
  dplyr::select(SITE, Type, Dmn_R_M, Elevation = areaDEM_cut, Slope = areaSLOPE_cut, Aspect = areaASPECT_cut,
                Distance = areaDIST_cut2)

pca_data_active <- dplyr::select(pca_data, Elevation,
                                 Aspect, Slope, Distance)

# Test assumptions
pca_Cor <- cor(pca_data_active)

# Sampling adequacy or an appropriate number of observations relative to the number of variables being examined
assumptions <- paf(as.matrix(pca_data_active), eigcrit = 1, convcrit = .001)
round(print(assumptions$KMO), 3)

# Positive determinant of the correlation or variance-covariance matrices
round(det(pca_Cor), 3)

# Sphericity or the existence of the identity matrix
bartlettTest <- cortest.bartlett(pca_Cor, n = 54)
round(bartlettTest$p.value, 3)

```


Three key assumptions were checked before applying PCA to our dataset: (1) the Bartlett’s Test for Sphericity p-value result of `r round(bartlettTest$p.value, 3)` rejects the null hypothesis that the intercorrelation matrix comes from a noncollinear population; (2) the Kaiser-Meyer-Olkin (KMO) value of `r round(print(assumptions$KMO)`, 3) approves sampling adequacy; (3) and the determinant of the correlation matrix is positive at `r round(det(pca_Cor), 3)`.


## Reproducibility and open source materials

The complete R code used for all the analysis and visualizations contained in this paper is available at XXX. To produce those files the procedures described by Marwick et al. XXX for the creation of research compendiums to enhance the reproducibility of research were followed. The files provided contain all the raw data used in our analysis as well as a custom R package XXX holding the code to produce all tables and figures. To enable maximum re-use, code is released under the MIT license, data as CC-0, and figures as CC-BY (for more information see XXX).


# Results

## General Patterns

Figure XXX presents the distribution of the 54 sites included in our short sample. A first evaluation of the distribution of the sites across the territory reveals a more dense concentration of sites in Central Portugal, a very weak presence of sites in northern regions, with only one site located in the Côa River valley (Aubry et al., 2020), and no sites located to the North of the Douro valley. Most of the sites present in this sample are open-air locations (n = 36), being noteworthy that both coastal (using current coastline as reference) and inland territories appear represented. Table \@ref(tab:general-table) summarizes the median and interquartile ranges for each of the extracted variables. Except for Slope, all remaining variables are not significantly different between open-air and cave sites. This is because cave and rockshelter sites tend to be located in areas with steeper slopes than open-air sites. In terms of elevation, the maximum altitude at which archaeological sites are found is 511 meters above current sea level (a.c.s.l.), corresponding this value to the cave site of Lapa do Picareiro, in central Portugal (Benedetti et al., 2019).


```{r general-table, eval = FALSE, echo = FALSE}


general_table <- as.data.frame(tabmulti(data = as.data.frame(sites_vals), xvarname = "Type",
              yvarnames = c("areaDEM_cut", "areaSLOPE_cut", "areaASPECT_cut", "areaDIST_cut2"),
              ymeasures = c("median", "median", "median", "median"),
              yvarlabels = list(areaDEM_cut = "Elevation", areaSLOPE_cut = "Slope", areaASPECT_cut = "Aspect", areaDIST_cut2 = "Distance")))

knitr::kable(general_table, caption = "Median and Interquartile Range (IQR) for all considered variables and site type. P-value is based on a Mann-Whitney U test.")

```


## Open air sites

Results of the analysis of individual variables comparing open-air sites with randomly resampled background points is presented in Figure \@ref(fig:open-air-plots) and Table \@ref(tab:table-stats-open). Only one of the variables, elevation, seems to attest that Middle Paleolithic sites are not randomly located in the landscape. In fact, while both curves are right skewed, there seems to be a clear tendency for the location of open-air sites at lower altitudes than the range of available elevations across the territory. The validity of this observation is confirmed by the results of the Mann-Whitney U test, which revealed a p-value of 0.00. The remaining three variables, Slope, Aspect and Distance to rivers, do not revealed any statistically significant differences between sites and background.  


```{r plot-altitude, eval = FALSE, echo = FALSE}

# Calculate site altitude densities
open_air_altitude_densities <- open_air %$%
   areaDEM_cut %>%
   density(from = -26, to = 1993, n = 1965) %>%
   broom::tidy() %>%
   tibble::as_tibble() %>%
   dplyr::mutate(y = y * 1965) %>%
   dplyr::rename(Elevation = x,
                Frequency = y)

# Load background values into memory for fast resampling
background_altitude_values <- areaDEM_cut %>%
  values() %>%
  na.omit()

# Draw 1000 random samples from background and calculate their densities
background_altitude_densities <- foreach::foreach(n = 1:1000, .combine = rbind) %do% {
  background_altitude_values %>%
    sample(nrow(open_air),
           replace = FALSE) %>%
    density(from = -26, to = 1993, n = 1965) %>%
    broom::tidy() %>%
    tibble::as_tibble() %>%
    dplyr::mutate(y = y * 1965)
} %>%
  dplyr::group_by(x) %>%
  purrrlyr::by_slice(function(x){
    quantile(x$y, probs = c(0.025, 0.5, 0.975)) %>%
      t() %>%
      broom::tidy()
  }, .collate = "cols") %>%
  magrittr::set_names(c("Elevation", "Lower CI", "Frequency", "Upper CI"))


# Plot distributions
open_air_elevation <- ggplot() +
  geom_line(data = background_altitude_densities,
            mapping = aes(x = Elevation,
                          y = Frequency)) +
  geom_ribbon(data = background_altitude_densities,
              mapping = aes(x = Elevation,
                            ymin = `Lower CI`,
                            ymax = `Upper CI`),
              alpha = 0.3) +
  geom_line(data = open_air_altitude_densities,
            mapping = aes(x = Elevation,
                          y = Frequency),
            color = "red") +
  theme_cowplot() +
  ylab("") + xlab("meters")


```

```{r test-altitude, echo = false, eval = FALSE}

# Draw 1000 random samples from background, and compute two-sample Wilcoxon tests (Mann-Whitney U tests)
background_altitude_MWU <- foreach(n = 1:1000, .combine = rbind) %do% {
  background_sample <- background_altitude_values %>%
    sample(nrow(open_air),
           replace = FALSE) %>%
    wilcox.test(x = open_air$areaDEM_cut,
                y = .,
                exact = FALSE) %>%
    broom::tidy() %>%
    tibble::as_tibble()

} %>%
  dplyr::select(statistic, p.value)


# Get the median test statistic and 95% confidence interval
background_altitude_MWU <- foreach::foreach(prob = c(0.025,0.5,0.975), .combine = rbind) %do% {
  background_altitude_MWU %>%
    dplyr::summarise_all(quantile, probs = prob)
} %>%
  t() %>%
  magrittr::set_colnames(c("Lower CI","Median","Upper CI")) %>%
  magrittr::set_rownames(c("U statistic","p-value"))


background_altitude_tab <- as.data.frame(round(background_altitude_MWU, 3))

background_altitude_tab <- background_altitude_tab %>% 
  rownames_to_column("Statistic") %>% 
  mutate(Variable = c("Elevation", "")) %>% 
  dplyr::select(Variable, Statistic, `Lower CI`, Median, `Upper CI`)


```


```{r plot-slope, eval = FALSE, echo = FALSE}

# Calculate site altitude densities
open_air_slope_densities <- open_air %$%
   areaSLOPE_cut %>%
   density(from = 0, to = 70, n = 35) %>%
   broom::tidy() %>%
   tibble::as_tibble() %>%
   dplyr::mutate(y = y * 35) %>%
   dplyr::rename(Slope = x,
                Frequency = y)

# Load background values into memory for fast resampling
background_slope_values <- areaSLOPE_cut %>%
  values() %>%
  na.omit()

# Draw 1000 random samples from background and calculate their densities
background_slope_densities <- foreach::foreach(n = 1:1000, .combine = rbind) %do% {
  background_slope_values %>%
    sample(nrow(open_air),
           replace = FALSE) %>%
    density(from = 0, to = 70, n = 35) %>%
    broom::tidy() %>%
    tibble::as_tibble() %>%
    dplyr::mutate(y = y * 35)
} %>%
  dplyr::group_by(x) %>%
  purrrlyr::by_slice(function(x){
    quantile(x$y, probs = c(0.025, 0.5, 0.975)) %>%
      t() %>%
      broom::tidy()
  }, .collate = "cols") %>%
  magrittr::set_names(c("Slope", "Lower CI", "Frequency", "Upper CI"))


# Plot distributions
open_air_slope <- ggplot() +
  geom_line(data = background_slope_densities,
            mapping = aes(x = Slope,
                          y = Frequency)) +
  geom_ribbon(data = background_slope_densities,
              mapping = aes(x = Slope,
                            ymin = `Lower CI`,
                            ymax = `Upper CI`),
              alpha = 0.3) +
  geom_line(data = open_air_slope_densities,
            mapping = aes(x = Slope,
                          y = Frequency),
            color = "red") +
  theme_cowplot() +
  ylab("") + xlab("degrees")


```

```{r test-slope, echo = false, eval = FALSE}

# Draw 1000 random samples from background, and compute two-sample Wilcoxon tests (Mann-Whitney U tests)
background_slope_MWU <- foreach(n = 1:1000, .combine = rbind) %do% {
  background_sample <- background_slope_values %>%
    sample(nrow(open_air),
           replace = FALSE) %>%
    wilcox.test(x = open_air$areaSLOPE_cut,
                y = .,
                exact = FALSE) %>%
    broom::tidy() %>%
    tibble::as_tibble()

} %>%
  dplyr::select(statistic, p.value)


# Get the median test statistic and 95% confidence interval
background_slope_MWU <- foreach::foreach(prob = c(0.025,0.5,0.975), .combine = rbind) %do% {
  background_slope_MWU %>%
    dplyr::summarise_all(quantile, probs = prob)
} %>%
  t() %>%
  magrittr::set_colnames(c("Lower CI","Median","Upper CI")) %>%
  magrittr::set_rownames(c("U statistic","p-value"))


background_slope_tab <- as.data.frame(round(background_slope_MWU, 3))

background_slope_tab <- background_slope_tab %>% 
  rownames_to_column("Statistic") %>% 
  mutate(Variable = c("Slope", "")) %>% 
  dplyr::select(Variable, Statistic, `Lower CI`, Median, `Upper CI`)

```


```{r plot-aspect, eval = FALSE, echo = FALSE}

# Calculate site altitude densities
open_air_aspect_densities <- open_air %$%
   areaASPECT_cut %>%
   density(from = -1, to = 360, n = 181) %>%
   broom::tidy() %>%
   tibble::as_tibble() %>%
   dplyr::mutate(y = y * 181) %>%
   dplyr::rename(Aspect = x,
                Frequency = y)

# Load background values into memory for fast resampling
background_aspect_values <- areaASPECT_cut %>%
  values() %>%
  na.omit()

# Draw 1000 random samples from background and calculate their densities
background_aspect_densities <- foreach::foreach(n = 1:1000, .combine = rbind) %do% {
  background_aspect_values %>%
    sample(nrow(open_air),
           replace = FALSE) %>%
    density(from = -1, to = 360, n = 181) %>%
    broom::tidy() %>%
    tibble::as_tibble() %>%
    dplyr::mutate(y = y * 181)
} %>%
  dplyr::group_by(x) %>%
  purrrlyr::by_slice(function(x){
    quantile(x$y, probs = c(0.025, 0.5, 0.975)) %>%
      t() %>%
      broom::tidy()
  }, .collate = "cols") %>%
  magrittr::set_names(c("Aspect", "Lower CI", "Frequency", "Upper CI"))


# Plot distributions
open_air_aspect <- ggplot() +
  geom_line(data = background_aspect_densities,
            mapping = aes(x = Aspect,
                          y = Frequency)) +
  geom_ribbon(data = background_aspect_densities,
              mapping = aes(x = Aspect,
                            ymin = `Lower CI`,
                            ymax = `Upper CI`),
              alpha = 0.3) +
  geom_line(data = open_air_aspect_densities,
            mapping = aes(x = Aspect,
                          y = Frequency),
            color = "red") +
  theme_cowplot() +
  ylab("") + xlab("degrees")


```

```{r test-aspect, echo = false, eval = FALSE}

# Draw 1000 random samples from background, and compute two-sample Wilcoxon tests (Mann-Whitney U tests)
background_aspect_MWU <- foreach(n = 1:1000, .combine = rbind) %do% {
  background_sample <- background_aspect_values %>%
    sample(nrow(open_air),
           replace = FALSE) %>%
    wilcox.test(x = open_air$areaASPECT_cut,
                y = .,
                exact = FALSE) %>%
    broom::tidy() %>%
    tibble::as_tibble()

} %>%
  dplyr::select(statistic, p.value)


# Get the median test statistic and 95% confidence interval
background_aspect_MWU <- foreach::foreach(prob = c(0.025,0.5,0.975), .combine = rbind) %do% {
  background_aspect_MWU %>%
    dplyr::summarise_all(quantile, probs = prob)
} %>%
  t() %>%
  magrittr::set_colnames(c("Lower CI","Median","Upper CI")) %>%
  magrittr::set_rownames(c("U statistic","p-value"))


background_aspect_tab <- as.data.frame(round(background_aspect_MWU, 3))

background_aspect_tab <- background_aspect_tab %>% 
  rownames_to_column("Statistic") %>% 
  mutate(Variable = c("Aspect", "")) %>% 
  dplyr::select(Variable, Statistic, `Lower CI`, Median, `Upper CI`)

```


```{r plot-distance, eval = FALSE, echo = FALSE}

# Calculate site altitude densities
open_air_distance_densities <- open_air %$%
   areaDIST_cut %>%
   density(from = 0, to = 7697, n = 350) %>%
   broom::tidy() %>%
   tibble::as_tibble() %>%
   dplyr::mutate(y = y * 350) %>%
   dplyr::rename(Distance = x,
                Frequency = y)

# Load background values into memory for fast resampling
background_distance_values <- areaDIST_cut %>%
  values() %>%
  na.omit()

# Draw 1000 random samples from background and calculate their densities
background_distance_densities <- foreach::foreach(n = 1:1000, .combine = rbind) %do% {
  background_distance_values %>%
    sample(nrow(open_air),
           replace = FALSE) %>%
    density(from = 0, to = 7697, n = 350) %>%
    broom::tidy() %>%
    tibble::as_tibble() %>%
    dplyr::mutate(y = y * 350)
} %>%
  dplyr::group_by(x) %>%
  purrrlyr::by_slice(function(x){
    quantile(x$y, probs = c(0.025, 0.5, 0.975)) %>%
      t() %>%
      broom::tidy()
  }, .collate = "cols") %>%
  magrittr::set_names(c("Distance", "Lower CI", "Frequency", "Upper CI"))


# Plot distributions
open_air_distance <- ggplot() +
  geom_line(data = background_distance_densities,
            mapping = aes(x = Distance,
                          y = Frequency)) +
  geom_ribbon(data = background_distance_densities,
              mapping = aes(x = Distance,
                            ymin = `Lower CI`,
                            ymax = `Upper CI`),
              alpha = 0.3) +
  geom_line(data = open_air_distance_densities,
            mapping = aes(x = Distance,
                          y = Frequency),
            color = "red") +
  theme_cowplot() +
  ylab("") + xlab("meters")


```

```{r test-aspect, echo = false, eval = FALSE}

# Draw 1000 random samples from background, and compute two-sample Wilcoxon tests (Mann-Whitney U tests)
background_distance_MWU <- foreach(n = 1:1000, .combine = rbind) %do% {
  background_sample <- background_distance_values %>%
    sample(nrow(open_air),
           replace = FALSE) %>%
    wilcox.test(x = open_air$areaDIST_cut,
                y = .,
                exact = FALSE) %>%
    broom::tidy() %>%
    tibble::as_tibble()

} %>%
  dplyr::select(statistic, p.value)


# Get the median test statistic and 95% confidence interval
background_distance_MWU <- foreach::foreach(prob = c(0.025,0.5,0.975), .combine = rbind) %do% {
  background_distance_MWU %>%
  dplyr::summarise_all(quantile, probs = prob)
} %>%
  t() %>%
  magrittr::set_colnames(c("Lower CI","Median","Upper CI")) %>%
  magrittr::set_rownames(c("U statistic","p-value"))


background_distance_tab <- as.data.frame(round(background_distance_MWU, 3))

background_distance_tab <- background_distance_tab %>% 
  rownames_to_column("Statistic") %>% 
  mutate(Variable = c("Distance", "")) %>% 
  dplyr::select(Variable, Statistic, `Lower CI`, Median, `Upper CI`)

```

```{r open-air-plots, eval = FALSE, echo = FALSE, fig.cap = "Kernel density plots comparing open-air sites (red line) and randomly resampled background points (black line) for A) Elevation, B) Slope, C) Aspect, and D) Distance to rivers. The grey areas represent the 95% confidence interval calculated from the resampling."}

plot_grid(open_air_elevation, open_air_slope, open_air_aspect, open_air_distance, labels = c("A", "B", "C", "D"), nrow = 2, ncol = 2)

```

```{r table-stats-open, eval = FALSE, echo = FALSE}

stats_table_open_air <- rbind(background_altitude_tab, background_slope_tab, background_aspect_tab, background_distance_tab)


knitr::kable(stats_table_open_air, caption = "Mann-Whitney U test results for the comparison between open-air sites and randomly resampled background points for the four variables considered in this study.")

```


## Caves


```{r caves-boxplots, eval = FALSE, echo = FALSE}


cave <- caves %>% 
  dplyr::select(SITE, areaDEM_cut, areaSLOPE_cut, areaASPECT_cut, areaDIST_cut2) %>% 
  mutate(TYPE = "MP Caves")


all_caves <- all_caves %>% 
  rename(SITE = Ã.__SITE) %>% 
  dplyr::select(SITE, areaDEM_cut, areaSLOPE_cut, areaASPECT_cut, areaDIST_cut2) %>% 
  mutate(TYPE = "All Caves")

cave <- rbind(cave, all_caves)

caves_elevation <- cave %>%
  mutate(TYPE = fct_relevel(TYPE, 
            "MP Caves", "All Caves")) %>% 
  ggplot(aes(x = TYPE, y = areaDEM_cut, fill = TYPE)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter() +
  ylab("meters") + xlab("") +
  theme_cowplot() +
  theme(legend.position="none") +
  scale_fill_brewer(palette = "Dark2")


caves_slope <- cave %>%
  mutate(TYPE = fct_relevel(TYPE, 
            "MP Caves", "All Caves")) %>%
  ggplot(aes(x = TYPE, y = areaSLOPE_cut, fill = TYPE)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter() +
  ylab("degrees") + xlab("") +
  theme_cowplot() +
  theme(legend.position="none") +
  scale_fill_brewer(palette = "Dark2")


caves_aspect <- cave %>% 
  mutate(TYPE = fct_relevel(TYPE, 
            "MP Caves", "All Caves")) %>%
  ggplot(aes(x = TYPE, y = areaASPECT_cut, fill = TYPE)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter() +
  ylab("degrees") + xlab("") +
  theme_cowplot() +
  theme(legend.position="none") +
  scale_fill_brewer(palette = "Dark2")

caves_distance <- cave %>% 
  mutate(TYPE = fct_relevel(TYPE, 
            "MP Caves", "All Caves")) %>%
  ggplot(aes(x = TYPE, y = areaDIST_cut2, fill = TYPE)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter() +
  ylab("meters") + xlab("") +
  theme_cowplot() +
  theme(legend.position="none") +
  scale_fill_brewer(palette = "Dark2")

plot_grid(caves_elevation, caves_slope, caves_aspect, caves_distance, labels=c("A", "B", "C", "D"), ncol = 2, nrow = 2)



```

```{r caves-statistics, eval = FALSE, echo = FALSE}

caves_elevation_MWU <- wilcox.test(areaDEM_cut ~ TYPE, data = cave,
                   exact = FALSE)

caves_slope_MWU <- wilcox.test(areaSLOPE_cut ~ TYPE, data = cave,
                   exact = FALSE)


caves_aspect_MWU <- wilcox.test(areaASPECT_cut ~ TYPE, data = cave,
                   exact = FALSE)


caves_distance_MWU <- wilcox.test(areaDIST_cut2 ~ TYPE, data = cave,
                   exact = FALSE)

variables <- c("Elevation", "Slope", "Altitude", "Distance")

u_statistics <- c(caves_elevation_MWU$statistic, caves_slope_MWU$statistic,
                   caves_aspect_MWU$statistic, caves_distance_MWU$statistic)

p_values <- c(caves_elevation_MWU$p.value, caves_slope_MWU$p.value,
                   caves_aspect_MWU$p.value, caves_distance_MWU$p.value)

caves_stats <- data.frame(variables, u_statistics, p_values)

caves_stats <- caves_stats %>% 
  rename(Variables = variables, `U statistic` = u_statistics, "p-value" = p_values) %>% 
  mutate(across(where(is.numeric), round, 2))

knitr::kable(caves_stats, caption = "Results of the Mann-Whitney U test, for each spatial variable, between caves with Middle Paleolithic occupations and all other archaeological caves identified in westernmost Iberia.")


```



## Principal Component Analysis


Table X presents the ‘loadings’ of each variable in the composition of the two first components, which represent, respectively c. 40.1% and c. 27.1% of the overall variability. Latitude and Slope were the variables that explained most variance in PC1, while Altitude and Distance to rivers explain most of the variance in PC2. Conversely, in PC1, the variables with less impact on the variability, i.e. Altitude, Aspect and Distance to water courses, can be considered the most important variables for settlement location, since their more restricted values represent the most sought after qualities for site occupation.


```{r pca-plot, eval = FALSE, echo = FALSE}

# Plot Results

res.pca <- prcomp(pca_data_active, scale = TRUE)

groups <- as.factor(pca_data$Dmn_R_M)

fviz_pca_biplot(res.pca,
                col.ind = groups,
                addEllipses = TRUE,
                ellipse.type = "confidence",
                legend.title = "Raw Material",
                repel = TRUE,
                label = "var",
                pointsize = 3) +
                theme(text = element_text(size=15), plot.title = element_text(lineheight=.8, face="bold"),                       plot.margin=unit(c(1,1,1,1),"cm"))


loadings_table <- round(as.data.frame(res.pca$rotation[,1:2]), 3)





```


# Discussion

# Conclusion

# Acknowledgements

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? You may need to change the path value
# if your Rmd is not in analysis/paper/
git2r::repository("../..")
```
